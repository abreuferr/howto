
#: Title : Instalação SonarQube
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : Roteiro para a instalação do software SonarQube
#: Options : None
#: Reference :

#
# Modificação dos parâmetros do kernel Linux
#

$ sudo vi /etc/sysctl.conf
  (...)
  vm.max_map_count=262144
  fs.file-max=65536
  ulimit -n 65536
  ulimit -u 4096

$ sudo vi /etc/security/limits.conf
  (...)
  sonarqube   -   nofile   65536
  sonarqube   -   nproc    4096

$ sudo reboot

#
# Instalação do OpenJDK e PostgreSQL
#
#
# Oracle JRE 11 or OpenJDK 11
#
# O SonarQube trabalha com as bases de dados
# Oracle, Microsoft SQL Server e PostgreSQL.

# Instalação do Java
$ sudo apt-get install openjdk-11-jdk -y

# Instalação do PostgreSQL
$ wget -q https://www.postgresql.org/media/keys/ACCC4CF8.asc -O - | sudo apt-key add -
$ sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt/ `lsb_release -cs`-pgdg main" >> /etc/apt/sources.list.d/pgdg.list'
$ sudo apt install postgresql postgresql-contrib -y
$ sudo systemctl enable postgresql
$ sudo systemctl start  postgresql
$ sudo systemctl status  postgresql

#
# Configuração do PostgreSQL
#

$ sudo passwd postgres
$ su - postgres
$ createuser sonar
$ psql
# ALTER USER sonar WITH ENCRYPTED PASSWORD 'SENHA';
# CREATE DATABASE sonarqube OWNER sonar;
# GRANT ALL PRIVILEGES ON DATABASE sonarqube to sonar;
# \q
$ exit
$ sudo systemctl enable postgresql
$ sudo systemctl status postgresql

#
# Instalação do SonarQube
#

# download do SonarQube
$ wget https://binaries.sonarsource.com/CommercialDistribution/sonarqube-developer/sonarqube-developer-8.9.0.43852.zip
$ unzip sonarqube-developer-8.9.0.43852.zip

#
# Configuração do SonarQube
#

$ sudo mv sonarqube-8.9.0.43852/ /opt/sonarqube
$ sudo groupadd sonar
$ sudo useradd -c "SonarQube - User" -d /opt/sonarqube/ -g sonar sonar
$ sudo chown -R sonar:sonar /opt/sonarqube/
$ sudo vi /opt/sonarqube/conf/sonar.properties
  sonar.jdbc.username=sonar
  sonar.jdbc.password=SENHA
  sonar.jdbc.url=jdbc:postgresql://localhost/sonarqube
  sonar.web.host=0.0.0.0
  sonar.web.port=9000
  sonar.web.javaAdditionalOpts=-server
  sonar.search.javaOpts=-Xmx512m -Xms512m -XX:+HeapDumpOnOutOfMemoryError
  sonar.log.level=INFO
  sonar.path.logs=logs

$ sudo vi /etc/systemd/system/sonarqube.service
  [Unit]
  Description=SonarQube service
  After=syslog.target network.target

  [Service]
  Type=forking
  ExecStart=/opt/sonarqube/bin/linux-x86-64/sonar.sh start
  ExecStop=/opt/sonarqube/bin/linux-x86-64/sonar.sh stop
  User=sonar
  Group=sonar
  Restart=always
  LimitNOFILE=65536
  LimitNPROC=4096

  [Install]
  WantedBy=multi-user.target

$ sudo systemctl enable sonarqube
$ sudo systemctl start sonarqube
$ sudo systemctl status sonarqube

#
# Instalação do webserver Nginx
#

$ sudo apt-get install nginx -y

$ sudo systemctl enable nginx
$ sudo systemctl start nginx
$ sudo systemctl status nginx

#
# Configuração do webserver Nginx
#

$ sudo vi /etc/nginx/sites-enabled/sonarqube.conf
  server{

      listen      80;
      server_name sonarqube.da.com;
      access_log  /var/log/nginx/sonar.access.log;
      error_log   /var/log/nginx/sonar.error.log;
      proxy_buffers 16 64k;
      proxy_buffer_size 128k;

      location / {
          proxy_pass  http://127.0.0.1:9000;
          proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
          proxy_redirect off;
          proxy_set_header    Host            $host;
          proxy_set_header    X-Real-IP       $remote_addr;
          proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header    X-Forwarded-Proto http;
      }
  }

$ sudo systemctl restart nginx

#
# Teste
#

# browser - http://<IP_SONARQUBE>:9000
