#: Title : nginx web server
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : Configuracao do Varnish Cache 
#: Options : None
#: Reference :  

INSTALACAO
# instalacao do nginx no debian
#
$ sudo apt-get install nginx -y -d

SYSTEMD
# start/stop/restart
#
$ sudo systemctl stop nginx	; parar o nginx
$ sudo systemctl start nginx	; inicializar o nginx
$ sudo systemctl restart nginx	; reinicializar o nginx
$ sudo systemctl reload nginx	; re-ler a configuracao
$ sudo systemctl enable nginx	; ativar o nginx no boot
$ sudo systemctl status nginx	; status do nginx

# VERIFICACAO
$ ps aux | grep nginx
	root       1385  0.0  1.3  91188  3052 ?        Ss   09:03   0:00 nginx: master process /usr/sbin/nginx -g daemon on; master_process on;
	www-data   1386  0.0  1.5  91556  3740 ?        S    09:03   0:00 nginx: worker process                           
	www-data   1388  0.0  1.5  91556  3740 ?        S    09:03   0:00 nginx: worker process                           
	www-data   1389  0.0  1.5  91556  3740 ?        S    09:03   0:00 nginx: worker process                           
	www-data   1390  0.0  1.5  91556  3740 ?        S    09:03   0:00 nginx: worker process                           

$ netstat -tulpn | grep :80
	(No info could be read for "-p": geteuid()=1000 but you should be root.)
	tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -               
	tcp6       0      0 :::80                   :::*                    LISTEN      -               

CONFIGURACAO PADRAO
#
# configuracao do nginx
#
$ sudo vi /etc/nginx/nginx.conf

#
# configuracao do site padrao armazenados no servidor
#
$ sudo vi /etc/nginx/sites-enabled/default

WWW.PARTICULA.LOCAL
#
# criacao do diretorio de trabalho
#
$ sudo mkdir /var/www/www.particula.local

#
# configuracao do site www.particula.local
#
$ sudo vi /etc/nginx/sites-available/www.particula.local.conf
	server {
	        listen 80;
	        listen [::]:80;

	        server_name www.particula.local;

        	root /var/www/www.particula.local;
	        index index.html;

        	location / {
                	try_files $uri $uri/ =404;
	        }
	}

#
# configuracao do site www.particula.local - link simbolico
#
$ sudo ln -s /etc/nginx/sites-available/www.particula.local.conf /etc/nginx/sites-enabled/www.particula.local.conf

#
# teste do arquivo de configuracao
#
$ sudo nginx -t
	nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
	nginx: configuration file /etc/nginx/nginx.conf test is successful

#
# releitura dos arquivos de configuracao
#
$ sudo systemctl reload nginx

#
# index.html
$ sudo vi /var/www/www.particula.local/index.html
	<!DOCTYPE html>
	<html>
	<head>
	<title>www.particula.local</title>
	<style>
	    body {
	        width: 35em;
	        margin: 0 auto;
	        font-family: Tahoma, Verdana, Arial, sans-serif;
	    }
	</style>
	</head>
	<body>
	<h1>www.particula.local</h1>
	</body>
	</html>

SEGURANCA
#
# a primeira dica de seguranca para o nginx eh a de salvar os
# dados em uma outra particao e montar essa nova particao com
# as opcoes nosuid,noexec,nodev no arquivo /etc/fstab. Desta
# forma, nenhum executavel podera ser executado nessa particao.
#
$ vi /etc/fstab
	/dev/sdb1       /mnt/www        ext4    defaults,nosuid,noexec,nodev    1       2

#
# sera necessario alterar os arquivos de configuracao do nginx
#
$ sudo vi /etc/nginx/sites-available/default
	(...)
	root /mnt/www/html;
	(...)

#
# www.particula.local
#
$ sudo vi /etc/nginx/sites-available/www.particula.local.conf
	(...)
	root /mnt/www/html;
	(...)

#
# prevenindo ataque do tipo Buffer Overflow
#
$ sudo vi /etc/nginx/nginx.conf
	http {
	(...)

		##
		# Buffer Overflow Attacks
		##
		client_body_buffer_size  1K;
		client_header_buffer_size 1k;
		client_max_body_size 1k;
		large_client_header_buffers 2 1k;

		##
		# Timeouts
		##
		client_body_timeout   10;
		client_header_timeout 10;
		send_timeout          10;

	(...)
	}
