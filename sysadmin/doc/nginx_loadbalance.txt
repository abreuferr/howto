#: Title : nginx and load balancer
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : Configuracao do NGinx para Load Balance
#: Options : None

INSTALACAO
# instalacao do nginx no debian
#
$ sudo vi /etc/apt/sources.list.d/nginx.list
        deb http://nginx.org/packages/mainline/debian/ stretch nginx
$ wget http://nginx.org/keys/nginx_signing.key
$ sudo apt-key add nginx_signing.key
$ sudo apt-get update
$ sudo apt-get install nginx -y -d

# instalacao do nginx no redhat/centos
#
$ sudo vi /etc/yum.repos.d/nginx.repo
        [nginx]
        name=nginx repo

        baseurl=http://nginx.org/packages/mainline/rhel/6/$basearch/
        baseurl=http://nginx.org/packages/mainline/rhel/7/$basearch/

        baseurl=http://nginx.org/packages/mainline/centos/6/$basearch/
        baseurl=http://nginx.org/packages/mainline/centos/7/$basearch/

        gpgcheck=0
        enabled=1
$ yum install nginx -y

SYSTEMD
# start/stop/restart
#
$ sudo systemctl stop nginx	; parar o nginx
$ sudo systemctl start nginx	; inicializar o nginx
$ sudo systemctl restart nginx	; reinicializar o nginx
$ sudo systemctl reload nginx	; re-ler a configuracao
$ sudo systemctl enable nginx	; ativar o nginx no boot
$ sudo systemctl status nginx	; status do nginx

# VERIFICACAO
$ ps aux | grep nginx
	root       1385  0.0  1.3  91188  3052 ?        Ss   09:03   0:00 nginx: master process /usr/sbin/nginx -g daemon on; master_process on;
	www-data   1386  0.0  1.5  91556  3740 ?        S    09:03   0:00 nginx: worker process                           
	www-data   1388  0.0  1.5  91556  3740 ?        S    09:03   0:00 nginx: worker process                           
	www-data   1389  0.0  1.5  91556  3740 ?        S    09:03   0:00 nginx: worker process                           
	www-data   1390  0.0  1.5  91556  3740 ?        S    09:03   0:00 nginx: worker process                           

$ netstat -tulpn | grep :80
	(No info could be read for "-p": geteuid()=1000 but you should be root.)
	tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -               
	tcp6       0      0 :::80                   :::*                    LISTEN      -               

CONFIGURACAO
#
# configuracao do nginx
#
$ sudo vi /etc/nginx/sites-available/particula.local
$ sudo ln -s /etc/nginx/sites-available/particula.local /etc/nginx/sites-enabled/particula.local

	# define quais serao os hosts que faram parte do load balance
	upstream nginxlb {
        	server web1.particula.local:80;
		server web2.particula.local:80;
		
		# sem nenhum tipo de parametro, sera selecionado o algoritmo round robin
		#
		# algoritmo que seleciona o servidor que possui a menor quantidade de conexoe
		least_conn;
	}

	server {
        	listen 80;
        	server_name particula.local nginxlb.particula.local;

        	location / {
			proxy_set_header Host $host;
                	proxy_pass  http://nginxlb;
        	}

	}		

#
# testando o arquivo de configuacao e
# reinicializando o servico.
#
$ sudo nginx -t
$ sudo systemctl restart nginx.service
