#: Title : Setup LVM Server
#: Author : "Caio Abreu Ferreira" <abreuferr_gmail.com>
#: Description : Setup LVM Server
#: Options : None

0. teoria
#                                                                                                                                                                  
# PH = phisical volume = volume fisico = sao os discos rigidos                                                                                                     
# propriamente ditos                                                                                                                                               
#                                                                                                                                                                  
# VG = volume group = grupo de volume = consiste no agrupamento                                                                                                    
# de PVs. basicamente consiste na reuniao de varios discos rigidos                                                                                                 
# para formar um ou mais grupos.                                                                                                                                   
#                                                                                                                                                                  
# LV = logical volume = volumes logicos = depois de reunir os varios                                                                                               
# discos rigidos em um ou mais grupos de volumes, agora podemos dividir                                                                                            
# esses varios grupos de volumes em vaios volumes logicos, como por                                                                                                
# exemplo, um volume para o samba, outro para paginas web (www) e assim                                                                                            
# por diante.                                                                                                                                                      
#                                                                                                                                                                  
# para esse teste serao utilizado tres discos rigidos, /dev/sd[bcde]1          

1. hardware

	$ sudo fdisk /dev/sd[bcd]
		Hex code (type L to list codes): <-- 8e

2. Install

	$ sudo apt-get install lvm2 dmsetup mdadm xfsprogs

3. LVM

# Create PV
	$ sudo pvcreate /dev/sd[bcd]1

# Delete PV
	$ sudo pvremove /dev/sd[bcd]1

# Show PV
	$ sudo pvdisplay

# Create VG
	$ sudo vgcreate vg_volume /dev/sd[bcd]1

# Show VG
	$ sudo vgdisplay

# Rename VG
	$ sudo vgrename vg_volume vg_data

# Delete VG
	$ sudo vgremove vg_data

# Create LV
	$ sudo lvcreate --name share --size 40G vg_volume

# Show LV
	$ sudo lvdisplay

# Rename LV
	$ sudo lvrename vg_volume share backup

# Delete LV
	$ sudo lvremove /dev/vg_volume/backup

# Add extra hardisk
	$ sudo fdisk /dev/sde
    $ sudo pvcreate /dev/sde1
	$ sudo vgextend vg_volume /dev/sde1
	$ sudo vgdisplay

4. File System

Format
	$ sudo mkfs.ext4 /dev/lvm_volume/backup

Mount
	$ sudo mkdir /mnt/backup
	$ sudo mount /dev/vg_volume/backup /mnt/backup

Fstab
	$ sudo vi /etc/fstab
	/dev/vg_volume/backup   /mnt/backup     ext4       rw,noatime    0 0

5. Ampliacao do LV

# resumo                                                                                                                                                           
#   - desmontar                                                                                                                                                    
#   - lvresize - refazer o tamanho do LV                                                                                                                           
#   - e2fsck - checar a integridade                                                                                                                                
#   - resize2fs - redimensionar o LV                                                                                                                               
#   - montar                                                                                                                                                       
#                                                                                                                                                                  
$ sudo umount /mnt/samba                                                                                                                                           
$ sudo lvresize -L 30GB /dev/vg_data/samba                                                                                                                         
$ sudo e2fsck -f /dev/vg_data/samba                                                                                                                                
$ sudo resize2fs /dev/vg_data/samba                                                                                                                                
$ sudo lvscan                                                                                                                                                      
$ sudo mount /mnt/samba                                  

6. Reducao do LV

# resumo                                                                                                                                                           
#   - desmontar                                                                                                                                                    
#   - e2fsck - checar a integridade                                                                                                                                
#   - resize2fs - redimensionar o LV                                                                                                                               
#   - lvreduce - reducao do tamanho do LV                                                                                                                          
#   - lvresize - ALTERNATIVA AO COMANDO LVREDUCE                                                                                                                   
#   - montar                                                                                                                                                       
#                                                                                                                                                                  
$ sudo umount /mnt/samba                                                                                                                                           
$ sudo e2fsck -f /dev/vg_data/samba                                                                                                                                
$ sudo resize2fs /dev/vg_data/samba 10G                                                                                                                            
$ sudo lvreduce --size -10G /dev/vg_data/samba  ; reduzir em 10GB                                                                                                  
$ sudo lvreduce --size 20G /dev/vg_data/samba  ; reduzir para 20GB                                                                                                 
$ sudo lvresize -L 10GB /dev/vg_data/samba                                                                                                                         
$ sudo lvscan                                                                                                                                                      
$ sudo mount /mnt/samba                     
